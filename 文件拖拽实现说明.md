# æ–‡ä»¶æ‹–æ‹½è·å–æ–‡ä»¶è·¯å¾„å®ç°è¯´æ˜

æœ¬é¡¹ç›®å®ç°äº†å®Œæ•´çš„æ–‡ä»¶æ‹–æ‹½åŠŸèƒ½ï¼Œæ”¯æŒåœ¨Tauriæ¡Œé¢ç¯å¢ƒå’ŒWebæµè§ˆå™¨ç¯å¢ƒä¸‹è·å–æ–‡ä»¶è·¯å¾„å¹¶æ‰“å¼€æ–‡ä»¶ã€‚å®ç°åˆ†ä¸ºä¸¤ä¸ªå±‚é¢ï¼š**Tauriç¯å¢ƒ**å’Œ**Webç¯å¢ƒ**ã€‚

## 1. æ•´ä½“æ¶æ„

### 1.1 åŒç¯å¢ƒæ”¯æŒ
- **Tauriç¯å¢ƒ**ï¼šä½¿ç”¨Tauriçš„åŸç”Ÿæ‹–æ‹½äº‹ä»¶ç›‘å¬ï¼Œå¯ç›´æ¥è·å–ç³»ç»Ÿæ–‡ä»¶è·¯å¾„
- **Webç¯å¢ƒ**ï¼šä½¿ç”¨HTML5 Drag & Drop APIï¼Œé€šè¿‡FileReaderè¯»å–æ–‡ä»¶å†…å®¹

### 1.2 æ ¸å¿ƒæ–‡ä»¶
- `src/App.jsx` - ä¸»åº”ç”¨ç»„ä»¶ï¼Œå¤„ç†Webç¯å¢ƒä¸‹çš„æ‹–æ‹½äº‹ä»¶
- `src/hooks/useFileManager.jsx` - æ–‡ä»¶ç®¡ç†Hookï¼Œå¤„ç†Tauriç¯å¢ƒä¸‹çš„æ‹–æ‹½ç›‘å¬
- `src/styles/drag-overlay.scss` - æ‹–æ‹½è§†è§‰åé¦ˆæ ·å¼

## 2. Tauriç¯å¢ƒå®ç°

### 2.1 é…ç½®å¯ç”¨
åœ¨ `src-tauri/tauri.conf.json` ä¸­å¯ç”¨æ‹–æ‹½åŠŸèƒ½ï¼š

```json
{
  "app": {
    "windows": [
      {
        "dragDropEnabled": true
      }
    ]
  }
}
```

### 2.2 äº‹ä»¶ç›‘å¬å®ç°
åœ¨ `useFileManager.jsx` ä¸­ç›‘å¬Tauriæ‹–æ‹½äº‹ä»¶ï¼š

```javascript
import { listen } from '@tauri-apps/api/event'

// ç›‘å¬æ–‡ä»¶æ‹–æ‹½æ”¾ç½®äº‹ä»¶
const unlistenFileDrop = listen('tauri://drag-drop', async (event) => {
    // éšè—æ‹–æ‹½è¦†ç›–å±‚
    window.dispatchEvent(new CustomEvent('tauri-drag-leave'));

    const { paths } = event.payload;
    if (Array.isArray(paths) && paths.length > 0) {
        for (const path of paths) {
            try {
                // æ£€æŸ¥æ˜¯å¦ä¸ºç›®å½•
                const isDirectory = await fileApi.isDirectory(path);
                
                if (isDirectory) {
                    // å¦‚æœæ˜¯ç›®å½•ï¼Œæ›´æ–°é¢åŒ…å±‘å¯¼èˆª
                    window.dispatchEvent(new CustomEvent('update-breadcrumb', {
                        detail: { path }
                    }));
                } else {
                    // å¦‚æœæ˜¯æ–‡ä»¶ï¼Œç›´æ¥æ‰“å¼€
                    await handleFileOpen(path);
                }
            } catch (error) {
                // é”™è¯¯å¤„ç†ï¼šå°è¯•ä½œä¸ºæ–‡ä»¶æ‰“å¼€
                try {
                    await handleFileOpen(path);
                } catch (fileError) {
                    console.error('Failed to open as file:', path, fileError);
                }
            }
        }
    }
})

// ç›‘å¬æ‹–æ‹½è¿›å…¥äº‹ä»¶
const unlistenDragEnter = listen('tauri://drag-enter', (_) => {
    window.dispatchEvent(new CustomEvent('tauri-drag-enter'));
})

// ç›‘å¬æ‹–æ‹½ç¦»å¼€äº‹ä»¶  
const unlistenDragLeave = listen('tauri://drag-leave', (_) => {
    window.dispatchEvent(new CustomEvent('tauri-drag-leave'));
})
```

### 2.3 Tauriäº‹ä»¶ç±»å‹
- `tauri://drag-drop` - æ–‡ä»¶æ”¾ç½®äº‹ä»¶ï¼ŒpayloadåŒ…å«æ–‡ä»¶è·¯å¾„æ•°ç»„
- `tauri://drag-enter` - æ‹–æ‹½è¿›å…¥çª—å£äº‹ä»¶
- `tauri://drag-leave` - æ‹–æ‹½ç¦»å¼€çª—å£äº‹ä»¶

## 3. Webç¯å¢ƒå®ç°

### 3.1 æ‹–æ‹½äº‹ä»¶å¤„ç†
åœ¨ `App.jsx` ä¸­å®ç°Webç¯å¢ƒçš„æ‹–æ‹½å¤„ç†ï¼š

```javascript
/**
 * å¤„ç†æ‹–æ‹½æ‚¬åœäº‹ä»¶
 */
const handleDragOver = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();
    
    if (!isDragOver) {
        setIsDragOver(true);
    }
}, [isDragOver]);

/**
 * å¤„ç†æ‹–æ‹½è¿›å…¥äº‹ä»¶
 */
const handleDragEnter = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragOver(true);
}, []);

/**
 * å¤„ç†æ‹–æ‹½ç¦»å¼€äº‹ä»¶
 */
const handleDragLeave = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();

    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX;
    const y = e.clientY;

    // æ£€æŸ¥é¼ æ ‡æ˜¯å¦çœŸæ­£ç¦»å¼€äº†æ‹–æ‹½åŒºåŸŸ
    if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
        setIsDragOver(false);
    }
}, []);
```

### 3.2 æ–‡ä»¶å¤„ç†é€»è¾‘
```javascript
/**
 * å¤„ç†æ–‡ä»¶æ‹–æ‹½æ”¾ç½®äº‹ä»¶
 */
const handleDrop = useCallback(async (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragOver(false);

    const hasTauri = typeof window !== 'undefined' && window['__TAURI_INTERNALS__'] !== undefined;

    if (!hasTauri) {
        const files = Array.from(e.dataTransfer.files);

        if (files.length === 0) {
            return;
        }

        for (const file of files) {
            try {
                if (file.webkitRelativePath) {
                    // å¤„ç†æ–‡ä»¶å¤¹æ‹–æ‹½
                    await fileManager.setOpenFile(file.webkitRelativePath);
                } else {
                    // å¤„ç†å•ä¸ªæ–‡ä»¶
                    let content;
                    let fileName = file.name;

                    try {
                        // ä½¿ç”¨FileReaderè¯»å–æ–‡ä»¶å†…å®¹
                        content = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = (e) => reject(e);
                            reader.readAsText(file, 'UTF-8');
                        });

                        await fileManager.setOpenFile(fileName, content, {
                            encoding: 'UTF-8',
                            lineEnding: 'LF'
                        });
                    } catch (error) {
                        // è¯»å–å¤±è´¥æ—¶åˆ›å»ºç©ºæ–‡ä»¶
                        console.error('Failed to read file:', error);
                        await fileManager.setOpenFile(fileName, '', {
                            encoding: 'UTF-8',
                            lineEnding: 'LF'
                        });
                    }
                }
            } catch (error) {
                console.error('Error processing file:', error);
            }
        }
    }
}, [fileManager]);
```

## 4. è§†è§‰åé¦ˆå®ç°

### 4.1 æ‹–æ‹½è¦†ç›–å±‚
é€šè¿‡ `isDragOver` çŠ¶æ€æ§åˆ¶æ‹–æ‹½è¦†ç›–å±‚çš„æ˜¾ç¤ºï¼š

```jsx
{isDragOver && (
    <div className="drag-overlay">
        <div className="drag-overlay-content">
            <div className="drag-icon">ğŸ“</div>
            <div className="drag-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
            <div className="drag-subtext">æ”¯æŒå¤šä¸ªæ–‡ä»¶åŒæ—¶æ‹–æ‹½</div>
        </div>
    </div>
)}
```

### 4.2 æ ·å¼å®šä¹‰
åœ¨ `drag-overlay.scss` ä¸­å®šä¹‰æ‹–æ‹½è¦†ç›–å±‚æ ·å¼ï¼š

```scss
.drag-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(24, 144, 255, 0.08);
  backdrop-filter: blur(4px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  animation: fadeIn 0.2s ease-in-out;
}

.drag-overlay-content {
  background: rgba(255, 255, 255, 0.95);
  border: 2px dashed #1890ff;
  border-radius: 16px;
  padding: 48px 64px;
  text-align: center;
  box-shadow: 
    0 16px 48px rgba(24, 144, 255, 0.12),
    0 8px 24px rgba(0, 0, 0, 0.08);
  animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  backdrop-filter: blur(8px);
  max-width: 400px;
}
```

## 5. ç¯å¢ƒæ£€æµ‹

### 5.1 Tauriç¯å¢ƒæ£€æµ‹
```javascript
const hasTauri = typeof window !== 'undefined' && window['__TAURI_INTERNALS__'] !== undefined;
```

### 5.2 å¤„ç†é€»è¾‘åˆ†ç¦»
- **Tauriç¯å¢ƒ**ï¼šä½¿ç”¨åŸç”Ÿäº‹ä»¶ç›‘å¬ï¼Œç›´æ¥è·å–æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
- **Webç¯å¢ƒ**ï¼šä½¿ç”¨HTML5 APIï¼Œé€šè¿‡FileReaderè¯»å–æ–‡ä»¶å†…å®¹

## 6. æ–‡ä»¶ç±»å‹å¤„ç†

### 6.1 æ–‡ä»¶ä¸ç›®å½•åŒºåˆ†
åœ¨Tauriç¯å¢ƒä¸­ï¼Œé€šè¿‡ `fileApi.isDirectory(path)` æ£€æŸ¥æ‹–æ‹½é¡¹æ˜¯å¦ä¸ºç›®å½•ï¼š
- **ç›®å½•**ï¼šæ›´æ–°é¢åŒ…å±‘å¯¼èˆªï¼Œä¸æ‰“å¼€ç¼–è¾‘å™¨
- **æ–‡ä»¶**ï¼šç›´æ¥åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€

### 6.2 é”™è¯¯å¤„ç†
```javascript
try {
    const isDirectory = await fileApi.isDirectory(path);
    if (isDirectory) {
        // å¤„ç†ç›®å½•
    } else {
        // å¤„ç†æ–‡ä»¶
    }
} catch (error) {
    // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå°è¯•ä½œä¸ºæ–‡ä»¶å¤„ç†
    try {
        await handleFileOpen(path);
    } catch (fileError) {
        console.error('Failed to open as file:', path, fileError);
    }
}
```

## 7. äº‹ä»¶æ¸…ç†

### 7.1 Tauriäº‹ä»¶æ¸…ç†
```javascript
return () => {
    unlistenOpenFile.then(fn => fn())
    unlistenFileDrop.then(fn => fn())
    unlistenDragEnter.then(fn => fn())
    unlistenDragLeave.then(fn => fn())
}
```

### 7.2 Webäº‹ä»¶æ¸…ç†
é€šè¿‡Reactçš„useEffectæ¸…ç†æœºåˆ¶è‡ªåŠ¨å¤„ç†DOMäº‹ä»¶çš„ç§»é™¤ã€‚

## 8. ç‰¹æ€§æ€»ç»“

### 8.1 æ”¯æŒçš„åŠŸèƒ½
- âœ… å•æ–‡ä»¶æ‹–æ‹½
- âœ… å¤šæ–‡ä»¶æ‹–æ‹½
- âœ… ç›®å½•æ‹–æ‹½ï¼ˆTauriç¯å¢ƒï¼‰
- âœ… æ–‡ä»¶å†…å®¹è¯»å–ï¼ˆWebç¯å¢ƒï¼‰
- âœ… è§†è§‰åé¦ˆ
- âœ… é”™è¯¯å¤„ç†
- âœ… åŒç¯å¢ƒå…¼å®¹

### 8.2 æŠ€æœ¯ç‰¹ç‚¹
- **è·¨å¹³å°å…¼å®¹**ï¼šåŒæ—¶æ”¯æŒæ¡Œé¢å’ŒWebç¯å¢ƒ
- **åŸç”Ÿæ€§èƒ½**ï¼šTauriç¯å¢ƒä¸‹ç›´æ¥ä½¿ç”¨ç³»ç»ŸAPI
- **ä¼˜é›…é™çº§**ï¼šWebç¯å¢ƒä¸‹æä¾›å®Œæ•´çš„æ–‡ä»¶è¯»å–åŠŸèƒ½
- **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›ç›´è§‚çš„æ‹–æ‹½è§†è§‰åé¦ˆ
- **é”™è¯¯æ¢å¤**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶

è¿™ç§å®ç°æ–¹å¼ç¡®ä¿äº†åº”ç”¨åœ¨ä¸åŒç¯å¢ƒä¸‹éƒ½èƒ½æä¾›ä¸€è‡´ä¸”å¯é çš„æ–‡ä»¶æ‹–æ‹½ä½“éªŒã€‚